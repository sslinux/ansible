# 08条件判断


* when的值是一个条件表达式，如果条件判断成立，这个task就执行，如果判断不成立，则task不执行
    
* 如果需要根据变量、facts（setup）或此前任务的执行结果来作为某task执行与否的前提时要用到条件测试，在Playbook中条件测试使用when子句。
    
* 在task后添加when子句即可使用条件测试：when子句支持jinjia2表达式或语法，例如：


```yaml
[root@blog playbooks]# cat when.yml
- hosts: test
  remote_user: root
  tasks:
    - name: "shutdown CentOS"
      command: /sbin/shutdown -h 100
      when: ansible_distribution == "CentOS"
```

```bash
[root@blog playbooks]# ansible-playbook when.yml 

PLAY [test] ***************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ****************************************************************************************************************************************************************************************************************************
ok: [192.168.1.44]

TASK [shutdown CentOS] ****************************************************************************************************************************************************************************************************************************
changed: [192.168.1.44]

PLAY RECAP ****************************************************************************************************************************************************************************************************************************************
192.168.1.44               : ok=2    changed=1    unreachable=0    failed=0   
```


## 多条件判断：

```bash
[root@blog playbooks]# cat multi_when.yml
- hosts: test
  remote_user: root
  tasks:
    - name: "shut down CentOS 6 systems"
      command: /sbin/shutdown -r 100
      when:
        - ansible_distribution == "CentOS"
        - ansible_distribution_major_version == "6"
```

多个条件写在 when下时，需要多个条件同时满足才会执行该task；


```bash
[root@blog playbooks]# ansible-playbook multi_when.yml

PLAY [test] ***************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ****************************************************************************************************************************************************************************************************************************
ok: [192.168.1.44]

TASK [shut down CentOS 6 systems] *****************************************************************************************************************************************************************************************************************
skipping: [192.168.1.44]

PLAY RECAP ****************************************************************************************************************************************************************************************************************************************
192.168.1.44               : ok=1    changed=0    unreachable=0    failed=0  
```

## 组合条件判断：

```bash
[root@blog playbooks]# vim multi_condition.yml
[root@blog playbooks]# cat multi_condition.yml
- hosts: test
  remote_user: root
  tasks:
    - name: "shut down CentOS 6 and Debian 7 systems"
      command: /sbin/shutdown -t now
      when: (ansible_distribution == "CentOS" and ansible_distribution_major_version == "6") or
            (ansible_distribution == "Debian" and ansible_distribution_major_version == "7")
[root@blog playbooks]# ansible-playbook multi_condition.yml
```

## 自定义条件判断：

```bash
[root@blog playbooks]# vim custom_condition.yml
[root@blog playbooks]# 
[root@blog playbooks]# cat custom_condition.yml 
- hosts: test
  vars:
    exist: "True"
    tasks:
    - name: create file
      command: touch /tmp/test.txt
      when: exist | match("True")
    - name: delete file
      command: rm -rf /tmp/test.txt
      when: exist | match("False")
[root@blog playbooks]# ansible-playbook custom_condition.yml
```


## 迭代： 

* 有需要重复性执行的任务时，可以使用迭代机制。

* 其使用格式为将需要迭代的内容定义为item变量引用，并通过with_items语句指明迭代的元素列表即可。


```bash
[root@blog playbooks]# vim items1.yml
[root@blog playbooks]# cat items1.yml
- hosts: test
  remote_user: root
  tasks:
    - name: "Install Packages"
      yum: name={{ item }} state=latest
      with_items:
        - httpd
        - mariadb-server 
        - php

# 依次安装三个服务；
[root@blog playbooks]# ansible-playbook items1.yml

PLAY [test] ***************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ****************************************************************************************************************************************************************************************************************************
ok: [192.168.1.44]

TASK [Install Packages] ***************************************************************************************************************************************************************************************************************************
changed: [192.168.1.44] => (item=[u'httpd', u'mariadb-server', u'php'])

PLAY RECAP ****************************************************************************************************************************************************************************************************************************************
192.168.1.44               : ok=2    changed=1    unreachable=0    failed=0   

```

```bash
[root@blog playbooks]# cat ites_user.yml 
- hosts: test
  remote_user: root
  tasks:
    - name: "Add users"
      user: name={{ item.name }} state=present group={{ item.groups }}
      with_items:
        - {name: 'test1', groups: 'wheel'}
        - {name: 'test2', groups: 'root'}
[root@blog playbooks]# ansible-playbook ites_user.yml

PLAY [test] ***************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ****************************************************************************************************************************************************************************************************************************
ok: [192.168.1.44]

TASK [Add users] **********************************************************************************************************************************************************************************************************************************
changed: [192.168.1.44] => (item={u'name': u'test1', u'groups': u'wheel'})
changed: [192.168.1.44] => (item={u'name': u'test2', u'groups': u'root'})

PLAY RECAP ****************************************************************************************************************************************************************************************************************************************
192.168.1.44               : ok=2    changed=1    unreachable=0    failed=0   
```

* 强调： 除非以冒号(:)结尾，否则冒号后必须有一个空格；

